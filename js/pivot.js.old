hg.Grid.PivotView=hg.View.extend({vnm:"PivotView",subcnt:0,seq:0,init:function(a){debug("Init PivotView");var b=this;this.model=new hg.Grid.Model(a),this.service=new hg.Service(this.model.get("ini"));var c=this.getTransPivotOpt(a);this.model=new hg.Grid.Model(this.model.data),this.cols=new hg.Cols(this.get("cols")),this.events=this.model.get("events"),this.cid=hg.generateCid("v_Grid"),this.model.bind("change",this.update,this),this.cols.flg=!0,this.col=new hg.Grid.ColView(this),this.render=new hg.Grid.RenderView(this),this.scroll={x:new hg.Grid.ScrollView(this,"x"),y:new hg.Grid.ScrollView(this,"y")},this.model.get("ini.resize")&&(this.resize=new hg.Grid.ResizeView(this)),this.model.get("sort.sortable")&&(this.sort=new hg.Grid.SortView(this));var d=this.get("ini.selectMode");if(d&&(this.selection=new hg.Grid.SelectionView(this)),this.model.get("rows.merge")&&(this.merge=new hg.Grid.MergeView(this)),this.data=new hg.Grid.DataView(this),this.model.set("ini.width",this.model.get("ini.width")),this.model.set("ini.height",this.model.get("ini.height")),c.length>0&&(this.page&&this.page.update(c.length),this.data.set("original",c),this.get("group.visible")&&this.get("group.groupingField")&&this.grouping.registGroupingColumn(this.get("group.groupingField")),this.fix=new hg.Grid.FixView(this),this.events.success.apply(this)),void 0!=hg.Grid.ImportView&&(this["import"]=new hg.Grid.ImportView(this)),this.model.get("search.visible")&&void 0!=hg.Grid.SearchView){this.search=new hg.Grid.SearchView(this);var e=this;hg.$(".grid_title .search",this.el).addEventListener("click",function(){e.search.searchDialog(e,this)})}if(void 0==this.model._events["mouseup@.hgrid"]&&this.model.bind("mouseup@.hgrid",this._grid_click,this),document.addEventListener("keydown",function(a){b._keydown(a,b)},!1),""==hg.browserName){if("M"==hg.appName.charAt(0)){var f=hg.appVersion.split("MSIE ")[1];f=f.split(".")[0],hg.browserName="IE"+f}"IE9"==hg.browserName&&hg.util.unselectable(document.body)}document.body.addEventListener("mousemove",this._mousemovePage),document.body.addEventListener("mouseup",this._mouseupPage)},getTransPivotOpt:function(options){var pData=this.service.send2(),aa=0,pvtCols,pvtColsNF,pvtRows,pvtRowsNF;void 0!=options.pivot.cols&&options.pivot.cols.length>0?(pvtCols=JSON.parse(JSON.stringify(options.pivot.cols)),pvtColsNF=!1):(pvtCols=[{name:"Total",id:"pivotTotal",width:"90px"}],pvtColsNF=!0),void 0!=options.pivot.rows&&options.pivot.rows.length>0?(pvtRows=JSON.parse(JSON.stringify(options.pivot.rows)),pvtRowsNF=!1):(pvtRows=[{name:"Total",id:"pivotTotal",width:"90px"}],pvtRowsNF=!0);for(var pvtVal=JSON.parse(JSON.stringify(options.pivot.vals)),pvtCArr=[],pvtCObj={},pvtRArr=[],pvtCArrCn=[],pvtRArrCn=[],pvtCRArr=JSON.parse(JSON.stringify(pvtCols)),pr=0;pr<pvtCRArr.length;pr++)pvtCRArr[pr].align="right",pvtCRArr[pr].style=pr%2==0?{header:{backgroundColor:"linear-gradient(to bottom, #f5ebcd 0%, #f7f1d7 100%)"}}:{header:{backgroundColor:"linear-gradient(to bottom, #c8f5c1 0%, #d0f7ce 100%)"}};pvtCRArr[pvtCRArr.length-1].sub=JSON.parse(JSON.stringify(pvtRows));for(var cr=pvtCRArr.length-1;cr>0;cr--)pvtCRArr[cr-1].sub=[pvtCRArr[cr]];for(var pCols=[pvtCRArr[0]],pColsIds=[],i=0;i<pData.length;i++){if(!pvtColsNF){for(var pColStr="",c=0;c<pvtCols.length;c++)pColStr+="_Pivot_"+pData[i][pvtCols[c].id];pColStr=pColStr.substring(7);var pCol={};if(-1==pvtCArr.indexOf(pColStr)){pvtCArr.push(pColStr);for(var pColStrArr=pColStr.split("_Pivot_"),pivotCn="",pColO=pCols.filter(function(a){return a.name==pColStrArr[0]}),idStr="",pcs=0;pcs<pColStrArr.length;pcs++)if(pivotCn+=" && pData[i]['"+pvtCols[pcs].id+"'] == '"+pColStrArr[pcs]+"'",0==pcs)1!=pColO.length?(pCol={},idStr+=pvtCols[pcs].id+"_Pivot_"+(pCols.length-1+""),pCol.id=idStr,pCol.name=pColStrArr[pcs],pCol.width=pvtCols[pvtCols.length-1].width,pCol.style={header:{backgroundColor:"linear-gradient(to bottom, #f5ebcd 0%, #f7f1d7 100%)"}},pCols.push(pCol),pColO=pCol):(idStr+=pColO[0].id,pColO=pColO[0]);else{void 0==pColO.sub&&(pColO.sub=[]),pColO=pColO.sub;var pClength=pColO.filter(function(a){return a.name==pColStrArr[pcs]}).length;1!=pClength?(pCol={},idStr+=pvtCols[pcs].id+"_Pivot_"+(pColO.length+""),pCol.id=idStr,pCol.name=pColStrArr[pcs],pCol.width=pvtCols[pcs].width,pCol.style=pcs%2==0?{header:{backgroundColor:"linear-gradient(to bottom, #f5ebcd 0%, #f7f1d7 100%)"}}:{header:{backgroundColor:"linear-gradient(to bottom, #c8f5c1 0%, #d0f7ce 100%)"}},pColO.push(pCol),pColO=pCol):(pColO=pColO.filter(function(a){return a.name==pColStrArr[pcs]})[0],idStr+=pColO.id)}pColsIds.push(idStr),pvtCObj[pColStr]=idStr,pvtCArrCn.push(pivotCn.substring(4))}}if(!pvtRowsNF){for(var pRowStr="",r=0;r<pvtRows.length;r++)pRowStr+="_Pivot_"+pData[i][pvtRows[r].id];if(pRowStr=pRowStr.substring(7),-1==pvtRArr.indexOf(pRowStr)){pvtRArr.push(pRowStr);for(var pRowStrArr=pRowStr.split("_Pivot_"),pivotCn="",c=0;c<pRowStrArr.length;c++)pivotCn+=" && pData[i]['"+pvtRows[c].id+"'] == '"+pRowStrArr[c]+"'";pvtRArrCn.push(pivotCn.substring(4))}}}switch(pvtRowsNF&&(pvtRArr.push("total"),pvtRArrCn.push(!0)),pvtVal.aggregator){case"sum":pCols.push({name:"합계",id:"sum",width:"100px"});break;case"avg":pCols.push({name:"평균",id:"avg",width:"100px"});break;case"count":pCols.push({name:"개수",id:"count",width:"100px"});break;case"min":pCols.push({name:"최소값",id:"min",width:"100px"});break;case"max":pCols.push({name:"최대값",id:"max",width:"100px"})}for(var original=new Array(pvtRArr.length),r=0;r<pvtRArr.length;r++){for(var pDataObj={},c=0;c<pColsIds.length;c++)pDataObj[pColsIds[c]]="";for(var pr=0;pr<pvtRows.length;pr++)pDataObj[pvtRows[pr].id]=pvtRArr[r].split("_Pivot_")[pr].replace("Pivot_","");pDataObj[pvtVal.aggregator]="",original[r]={row:pDataObj,idx:r,pc:pvtRArr[r]}}for(var i=0;i<pData.length;i++)for(var pr=0;pr<pvtRArrCn.length;pr++)if(eval(pvtRArrCn[pr])){for(var pc=0;pc<pvtCArrCn.length;pc++)if(eval(pvtCArrCn[pc])){switch(pvtVal.aggregator){case"sum":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]);original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]=nowVal+Number(pData[i][pvtVal.id]);break;case"avg":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]),nowCtn=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]+"_cnt"]||0);original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]=nowVal+Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]+"_cnt"]=nowCtn+1;break;case"count":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]);original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]=nowVal+1;break;case"min":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]);if(""===original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]){nowVal=Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]=nowVal;break}nowVal>Number(pData[i][pvtVal.id])&&(nowVal=Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]=nowVal);break;case"max":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]);nowVal<Number(pData[i][pvtVal.id])&&(nowVal=Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtCObj[pvtCArr[pc]]]=nowVal)}break}switch(pvtVal.aggregator){case"sum":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]);original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row.sum=nowVal+Number(pData[i][pvtVal.id]);break;case"avg":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]),nowCtn=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator+"_cnt"]||0);original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]=nowVal+Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator+"_cnt"]=nowCtn+1;break;case"count":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]);original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]=nowVal+1;break;case"min":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]);if(""===original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]){nowVal=Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]=nowVal;break}nowVal>Number(pData[i][pvtVal.id])&&(nowVal=Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]=nowVal);break;case"max":var nowVal=Number(original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]);nowVal<Number(pData[i][pvtVal.id])&&(nowVal=Number(pData[i][pvtVal.id]),original.filter(function(a){return a.pc==pvtRArr[pr]})[0].row[pvtVal.aggregator]=nowVal)}break}if("avg"==pvtVal.aggregator)for(var i=0;i<original.length;i++){for(var j=0;j<pColsIds.length;j++)Number(original[i].row[pColsIds[j]])>0&&(original[i].row[pColsIds[j]]=Math.round(original[i].row[pColsIds[j]]/original[i].row[pColsIds[j]+"_cnt"]*1e3)/1e3,delete original[i].row[pColsIds[j]+"_cnt"]);Number(original[i].row[pvtVal.aggregator])>0&&(original[i].row[pvtVal.aggregator]=Math.round(original[i].row[pvtVal.aggregator]/original[i].row[pvtVal.aggregator+"_cnt"]*1e3)/1e3,delete original[i].row[pvtVal.aggregator+"_cnt"])}for(var sortingValue=[],resultFunction=[],pr=0;pr<pvtRows.length;pr++)sortingValue.push({id:pvtRows[pr].id,sortby:"asc"});for(var j=0;j<sortingValue.length;j++){var sortid=sortingValue[j].id,sortby=sortingValue[j].sortby;resultFunction.push(hg.util.sort_by(sortid,"asc"===sortby?!0:!1,function(a){return hg.util.typeChanger(a)}))}return original.sort(hg.util.chainSortBy(resultFunction)),this.model.data.cols=pCols,this.model.data.fix={row:0,col:pvtRows.length},this.model.data.ini.refresh=!1,original},_addPivotFooter:function(a,b){for(var c=0;c<a.length;c++)void 0!=a[c].sub?this._addPivotFooter(a[c].sub,b):a[c].footer={fildNm:a[c].id,oper:b,style:{textAlign:"right",fontWeight:"bold",comma:!0}}}},hg.Grid.View);